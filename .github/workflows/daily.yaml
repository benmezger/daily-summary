name: Create daily summary
on:
  workflow_dispatch:
    inputs:
      date:
        description: 'Date for the summary (YYYY-MM-DD). Defaults to yesterday.'
        required: false
        type: string
        default: ''
  schedule:
    # 23:00 UTC = 00:00 CET (Winter) / 01:00 CEST (Summer)
    - cron: "0 23 * * *"

jobs:
  create-summary:
    runs-on: ubuntu-latest
    permissions: write-all
    strategy:
      matrix:
        include:
          - token_name: GH_TOKEN
            display_name: Personal
            extra_label: "personal"
            username: "benmezger"
          - token_name: GH_ENTERPRISE_TOKEN
            display_name: Work
            extra_label: "work"
            username: "benjaminm_backbase"
    concurrency:
      group: daily-${{ matrix.token_name }}
      cancel-in-progress: true
    env:
      SUMMARY_REPOSITORY: "benmezger/summaries"
      SUMMARY_ASSIGNEE: "benmezger"
      TIMEZONE: "Europe/Amsterdam"
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.6.4"
          enable-cache: true

      - name: Cache virtual environment
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('uv.lock') }}

      - name: Install project dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: uv sync

      - name: Set timezone
        run: sudo timedatectl set-timezone "$TIMEZONE"

      - name: Set target date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "TARGET_DATE=${{ inputs.date }}" >> $GITHUB_ENV
          else
            echo "TARGET_DATE=$(date -d 'yesterday' '+%Y-%m-%d')" >> $GITHUB_ENV
          fi

      - name: Set current year
        run: |
          echo "CURRENT_YEAR=$(date -d "$TARGET_DATE" '+%Y')" >> $GITHUB_ENV

      - name: Install GH milestones extension
        run: gh extension install valeriobelli/gh-milestone
        env:
          GH_TOKEN: ${{ secrets[matrix.token_name] }}

      - name: Generate daily summary
        id: summary
        run: |
          FILENAME="daily-${{ matrix.token_name }}.md"
          uv run task cli \
              --file $FILENAME --username ${{ matrix.username }} \
              daily-summary --date "$TARGET_DATE" --escape --no-ollama

          if [ -f $FILENAME ]; then
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ -n "$line" ]]; then
                echo "::add-mask::$line"
              fi
            done < $FILENAME

            {
              echo "text<<EOF"
              cat $FILENAME
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "text<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets[matrix.token_name] }}

      - name: Maybe create milestone
        run: |
          milestones=$(gh milestone list --repo $SUMMARY_REPOSITORY)

          if ! echo "$milestones" | grep -q "$CURRENT_YEAR"; then
            echo "Milestone for $CURRENT_YEAR not found. Creating."
            gh milestone create \
               --title "$CURRENT_YEAR" \
               --description "$CURRENT_YEAR contributions" \
               --due-date $(date -d "$((CURRENT_YEAR+1))-01-01 -1 second" +"%F")  \
               --repo "$SUMMARY_REPOSITORY"
          else
            echo "Milestone for $CURRENT_YEAR already exists. Skipping"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Maybe post issue and lock
        if: ${{ steps.summary.outputs.text }}
        run: |
          EXTRA_LABEL="${{ matrix.extra_label }}"
          LABEL_FLAGS="--label summary"
          if [ -n "$EXTRA_LABEL" ]; then
            LABEL_FLAGS="$LABEL_FLAGS --label $EXTRA_LABEL"
          fi

          ISSUE_URL=$(gh issue --repo "$SUMMARY_REPOSITORY" create \
            --title "[${{ matrix.display_name }}] Daily Summary of \`$TARGET_DATE\`" \
            --body "${{ steps.summary.outputs.text }}" \
            --assignee "$SUMMARY_ASSIGNEE" \
            --milestone "$CURRENT_YEAR" \
            $LABEL_FLAGS | grep -o 'https://github.com[^ ]*')

          gh issue lock "$ISSUE_URL"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Maybe post issue without a summary
        if: ${{ steps.summary.outputs.text == '' }}
        run: |
          EXTRA_LABEL="${{ matrix.extra_label }}"
          LABEL_FLAGS="--label no-summary"
          if [ -n "$EXTRA_LABEL" ]; then
            LABEL_FLAGS="$LABEL_FLAGS --label $EXTRA_LABEL"
          fi

          ISSUE_URL=$(gh issue --repo "$SUMMARY_REPOSITORY" create \
            --title "[${{ matrix.display_name }}] No summary available for \`$TARGET_DATE\`" \
            --body "No summary available." \
            --assignee "$SUMMARY_ASSIGNEE" \
            --milestone "$CURRENT_YEAR" \
            $LABEL_FLAGS | grep -o 'https://github.com[^ ]*')

          gh issue lock "$ISSUE_URL"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
